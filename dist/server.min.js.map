{"version":3,"sources":["server.js"],"names":["express","require","mongoose","cors","app","PORT","PDFDocument","use","origin","methods","allowedHeaders","limit","urlencoded","extended","json","req","res","next","headers","body","JSON","parse","console","log","e","error","connect","dbURI","then","err","userSchema","Schema","username","type","String","required","unique","role","default","User","findOne","newAdmin","password","save","createAdminUser","post","_req$body","userId","productId","user","updatedUser","regeneratorRuntime","async","_context2","prev","abrupt","status","message","awrap","UserCliente","findById","sent","favorites","includes","push","_toConsumableArray","Set","map","f","toString","populate","t0","stop","get","_context3","params","_req$params","before","_context4","length","filter","fav","users","_context5","find","_req$body2","_context6","_req$body3","newUser","_context7","userClienteSchema","direccion","Types","ObjectId","ref","model","clientes","_context8","select","_req$body4","nombre","email","telefono","_nodemailer","_transporter","newCliente","mailOptions","clienteResponse","_context9","receivedData","nodemailer","transporter","createTransport","service","auth","from","to","subject","text","concat","sendMail","info","response","_id","cliente","code","_req$body5","_context10","success","deletedCliente","_context11","findByIdAndDelete","id","pass","productSchema","codigo","Number","description","image","image1","image2","image3","stock","category","estado","enum","videoURL","featuresText","existingUser","destacado","Boolean","Product","_req$query","query","products","_context12","product","_context13","_req$body6","name","tagsText","newProduct","_context14","Object","keys","stack","updatedProduct","_context15","findByIdAndUpdate","new","_context16","ordenSchema","productos","price","Date","now","Orden","total","nuevaOrden","resumen","p","cantidad","mensaje","_context17","ordenes","_context18","sort","fecha","interaccionSchema","usuario","nueva","_context19","Interaccion","interacciones","_context20","cotizacionSchema","dniRuc","telefonoMovil","categoria","precioUnitario","numeroCotizacion","nuevaCotizacion","pdfBuffer","_context21","Cotizacion","countDocuments","padStart","contacto","pdfBase64","Buffer","process","env","EMAIL_USER","EMAIL_OWNER","attachments","filename","content","contentType","totalPendientes","_context22","_context23","_context24","historial","_context25","forEach","cot","Array","isArray","precio","data","cotizaciones","_context26","path","strictPopulate","lean","producto","productoId","equipo","imagen","count","cotizacionId","cotizacion","_context27","receivedHeaders","estadosPermitidos","_context28","toLowerCase","put","updatedAt","runValidators","_context29","_context30","listen"],"mappings":"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","file":"server.min.js","sourcesContent":["const express = require('express');\r\nconst mongoose = require('mongoose');\r\nconst cors = require('cors');\r\nconst app = express();\r\nconst PORT = 3000;\r\n\r\nconst PDFDocument = require('pdfkit');\r\n\r\n\r\n// Middleware - IMPORTANTE: el orden es crucial\r\n// CORS primero\r\napp.use(cors({\r\n  origin: ['http://localhost:4200', 'http://localhost:3200'], // acepta ambos\r\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\r\n  allowedHeaders: ['Content-Type', 'Authorization']\r\n}));\r\napp.use(express.json({ limit: '60mb' })); // aceptar JSON grandes\r\napp.use(express.urlencoded({ extended: true, limit: '50mb' })); // aceptar formularios grandes\r\napp.use(express.json({ limit: '80mb' })); // muy importante para im√°genes en base64\r\n\r\n\r\n// Middleware personalizado para convertir text/plain a JSON cuando es necesario\r\napp.use((req, res, next) => {\r\n    if (req.headers['content-type'] === 'text/plain' && req.body && typeof req.body === 'string') {\r\n        try {\r\n            req.body = JSON.parse(req.body);\r\n            console.log('Converted text/plain to JSON:', req.body);\r\n        } catch (e) {\r\n            console.error('Failed to parse text/plain as JSON:', e);\r\n        }\r\n    }\r\n    next();\r\n});\r\n\r\n// MongoDB Connection\r\nconst dbURI = 'mongodb://localhost:27017/mydatabase';\r\nmongoose.connect(dbURI)\r\n    .then(() => console.log('MongoDB connected'))\r\n    .catch(err => console.error('MongoDB connection error:', err));\r\n\r\n// User Schema\r\nconst userSchema = new mongoose.Schema({\r\n    username: { type: String, required: true, unique: true },\r\n    password: { type: String, required: true },\r\n    role: { type: String, default: 'admin' }\r\n});\r\nconst User = mongoose.model('User', userSchema);\r\n\r\n// Default Admin User\r\nasync function createAdminUser() {\r\n    const admin = await User.findOne({ username: 'admin' });\r\n    if (!admin) {\r\n        const newAdmin = new User({ username: 'admin', password: 'admin123', role: 'admin' });\r\n        await newAdmin.save();\r\n        console.log('Admin user created');\r\n    } else {\r\n        console.log('Admin user already exists');\r\n    }\r\n}\r\ncreateAdminUser();\r\n\r\n// üìå Agregar producto a favoritos\r\napp.post('/favorites', async (req, res) => {\r\n  try {\r\n    const { userId, productId } = req.body;\r\n\r\n    if (!userId || !productId) {\r\n      return res.status(400).json({ message: \"Faltan userId o productId\" });\r\n    }\r\n\r\n    const user = await UserCliente.findById(userId); // üëà cambio a UserCliente\r\n    if (!user) return res.status(404).json({ message: \"Usuario no encontrado\" });\r\n\r\n    if (!user.favorites.includes(productId)) {\r\n      user.favorites.push(productId);\r\n      user.favorites = [...new Set(user.favorites.map(f => f.toString()))];\r\n      await user.save();\r\n    }\r\n\r\n    const updatedUser = await UserCliente.findById(userId).populate('favorites'); // üëà cambio\r\n    res.json({\r\n      message: \"Producto agregado a favoritos\",\r\n      favorites: updatedUser.favorites\r\n    });\r\n  } catch (err) {\r\n    console.error(\"‚ùå Error en POST /favorites:\", err);\r\n    res.status(500).json({ message: \"Error al agregar a favoritos\", error: err.message });\r\n  }\r\n});\r\n\r\n// üìå Obtener favoritos de un cliente\r\napp.get('/favorites/:userId', async (req, res) => {\r\n  try {\r\n    const { userId } = req.params;\r\n\r\n    const user = await UserCliente.findById(userId).populate('favorites'); // üëà cambio\r\n    if (!user) return res.status(404).json({ message: \"Usuario no encontrado\" });\r\n\r\n    res.json({\r\n      message: \"Favoritos obtenidos correctamente\",\r\n      favorites: user.favorites\r\n    });\r\n  } catch (err) {\r\n    console.error(\"‚ùå Error en GET /favorites/:userId:\", err);\r\n    res.status(500).json({ message: \"Error al obtener favoritos\", error: err.message });\r\n  }\r\n});\r\n\r\n// üìå Eliminar producto de favoritos\r\napp.delete('/favorites/:userId/:productId', async (req, res) => {\r\n  try {\r\n    const { userId, productId } = req.params;\r\n\r\n    const user = await UserCliente.findById(userId); // üëà cambio\r\n    if (!user) return res.status(404).json({ message: \"Usuario no encontrado\" });\r\n\r\n    const before = user.favorites.length;\r\n    user.favorites = user.favorites.filter(fav => fav.toString() !== productId);\r\n\r\n    if (before === user.favorites.length) {\r\n      return res.status(404).json({ message: \"Producto no estaba en favoritos\" });\r\n    }\r\n\r\n    await user.save();\r\n    const updatedUser = await UserCliente.findById(userId).populate('favorites'); // üëà cambio\r\n\r\n    res.json({\r\n      message: \"Producto eliminado de favoritos\",\r\n      favorites: updatedUser.favorites\r\n    });\r\n  } catch (err) {\r\n    console.error(\"‚ùå Error en DELETE /favorites/:userId/:productId:\", err);\r\n    res.status(500).json({ message: \"Error al eliminar de favoritos\", error: err.message });\r\n  }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// Rutas de Usuario\r\napp.get('/users', async (req, res) => {\r\n    try {\r\n        const users = await User.find();\r\n        res.json(users);\r\n    } catch (err) {\r\n        res.status(500).json({ message: 'Error al obtener usuarios', error: err });\r\n    }\r\n});\r\n\r\napp.post('/login', async (req, res) => {\r\n    const { username, password } = req.body;\r\n    const user = await User.findOne({ username, password });\r\n    if (user) {\r\n        res.json({ message: 'Login successful', user });\r\n    } else {\r\n        res.status(401).json({ message: 'Invalid credentials' });\r\n    }\r\n});\r\n\r\n// Registro de Cliente\r\napp.post('/register', async (req, res) => {\r\n    const { username, password } = req.body;\r\n    try {\r\n        const existingUser = await User.findOne({ username });\r\n        if (existingUser) {\r\n            return res.status(400).json({ message: 'El usuario ya existe' });\r\n        }\r\n\r\n        const newUser = new User({ username, password, role: 'cliente' });\r\n        await newUser.save();\r\n        res.status(201).json({ message: 'Cliente registrado correctamente', user: newUser });\r\n    } catch (err) {\r\n        res.status(500).json({ message: 'Error al registrar cliente', error: err });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n//===========================USER CLIENTE =================///\r\n\r\n\r\nconst userClienteSchema = new mongoose.Schema({\r\n  password: { type: String, required: true },               \r\n  nombre: { type: String, required: true },                 \r\n  email: { type: String, required: true, unique: true },    \r\n  telefono: { type: String },                               \r\n  direccion: { type: String },       \r\n    favorites: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Product' }] // ‚≠ê nuevo campo\r\n                        \r\n});\r\n\r\nconst UserCliente = mongoose.model('UserCliente', userClienteSchema);\r\n\r\napp.get('/clientes', async (req, res) => {\r\n    try {\r\n        const clientes = await UserCliente.find().select('-password'); // No devolver passwords\r\n        res.json(clientes);\r\n    } catch (err) {\r\n        res.status(500).json({ message: 'Error al obtener clientes', error: err.message });\r\n    }\r\n});\r\n\r\n\r\n// Registro de nuevo cliente\r\napp.post('/clientes/register', async (req, res) => {\r\n    try {\r\n        console.log('Datos recibidos para registro:', req.body);\r\n        \r\n        const { password, nombre, email, telefono, direccion } = req.body;\r\n\r\n        // Validaciones\r\n        if (!password || !nombre || !email) {\r\n            return res.status(400).json({ \r\n                message: 'Password, nombre y email son obligatorios',\r\n                receivedData: req.body\r\n            });\r\n        }\r\n\r\n        // Verificar si el email ya existe\r\n        const existingCliente = await UserCliente.findOne({ email });\r\n        if (existingCliente) {\r\n            return res.status(400).json({ message: 'El email ya est√° registrado' });\r\n        }\r\n        const nodemailer = require('nodemailer');\r\n\r\n// Configura tu transporte (puede ser Gmail)\r\nconst transporter = nodemailer.createTransport({\r\n  service: 'gmail',\r\n  auth: {\r\n    user: 'monica.romeroz.2003@gmail.com', // <-- tu correo Gmail\r\n    pass: 'txapatbhiebaxbbg'   // <-- tu contrase√±a de app (¬°no tu clave real!)\r\n  }\r\n});\r\n\r\n\r\n        // Crear nuevo cliente\r\n        const newCliente = new UserCliente({ \r\n            password, \r\n            nombre, \r\n            email, \r\n            telefono: telefono || '', \r\n            direccion: direccion || '' \r\n        });\r\n\r\n        await newCliente.save();\r\n\r\n// ENVIAR CORREO AL CLIENTE\r\nconst mailOptions = {\r\n  from: 'monica.romeroz.2003@gmail.com',\r\n  to: email,\r\n  subject: 'Registro en la Web de DINSAC',\r\n  text: `¬°Hola ${nombre}! \r\n  ¬°Gracias por registrarte en la plataforma de DINSAC!\r\n\r\nAhora puedes explorar nuestros productos y realizar tus compras cuando gustes.  \r\nSi tienes dudas, escr√≠benos a soporte@dinsac.com\r\n\r\n¬°Que tengas un excelente d√≠a!\r\n\r\nAtentamente,  \r\nEl equipo de DINSAC..`\r\n};\r\n\r\ntransporter.sendMail(mailOptions, (error, info) => {\r\n  if (error) {\r\n    console.error('Error al enviar correo:', error);\r\n  } else {\r\n    console.log('Correo enviado: ' + info.response);\r\n  }\r\n});\r\n\r\n        \r\n        // Devolver cliente sin password\r\n        const clienteResponse = {\r\n            _id: newCliente._id,\r\n            nombre: newCliente.nombre,\r\n            email: newCliente.email,\r\n            telefono: newCliente.telefono,\r\n            direccion: newCliente.direccion\r\n        };\r\n\r\n        res.status(201).json({ \r\n            message: 'Cliente registrado correctamente', \r\n            cliente: clienteResponse \r\n        });\r\n    } catch (err) {\r\n        console.error('Error registrando cliente:', err);\r\n        if (err.code === 11000) {\r\n            // Error de duplicado de MongoDB\r\n            res.status(400).json({ message: 'El email ya est√° registrado' });\r\n        } else {\r\n            res.status(500).json({ message: 'Error al registrar cliente', error: err.message });\r\n        }\r\n    }\r\n});\r\n\r\n// Login de cliente\r\napp.post('/clientes/login', async (req, res) => {\r\n    try {\r\n        console.log('Intento de login:', req.body);\r\n        \r\n        const { email, password } = req.body;\r\n\r\n        // Validaciones\r\n        if (!email || !password) {\r\n            return res.status(400).json({ message: 'Email y password son obligatorios' });\r\n        }\r\n\r\n        // Buscar cliente por email y password\r\n        const cliente = await UserCliente.findOne({ email, password });\r\n        \r\n        if (cliente) {\r\n            // Login exitoso - devolver datos sin password\r\n            const clienteResponse = {\r\n                _id: cliente._id,\r\n                nombre: cliente.nombre,\r\n                email: cliente.email,\r\n                telefono: cliente.telefono,\r\n                direccion: cliente.direccion\r\n            };\r\n            \r\n            res.json({ \r\n                message: 'Login exitoso', \r\n                cliente: clienteResponse,\r\n                success: true\r\n            });\r\n        } else {\r\n            res.status(401).json({ \r\n                message: 'Credenciales inv√°lidas',\r\n                success: false\r\n            });\r\n        }\r\n    } catch (err) {\r\n        console.error('Error en login:', err);\r\n        res.status(500).json({ message: 'Error en el servidor', error: err.message });\r\n    }\r\n});\r\n\r\n\r\n// Eliminar cliente\r\napp.delete('/clientes/:id', async (req, res) => {\r\n    try {\r\n        const deletedCliente = await UserCliente.findByIdAndDelete(req.params.id);\r\n        \r\n        if (!deletedCliente) {\r\n            return res.status(404).json({ message: 'Cliente no encontrado' });\r\n        }\r\n\r\n        res.json({ \r\n            message: 'Cliente eliminado correctamente',\r\n            cliente: {\r\n                _id: deletedCliente._id,\r\n                nombre: deletedCliente.nombre,\r\n                email: deletedCliente.email\r\n            }\r\n        });\r\n    } catch (err) {\r\n        console.error('Error eliminando cliente:', err);\r\n        res.status(500).json({ message: 'Error eliminando cliente', error: err.message });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// =================== PRODUCTOS ===================\r\nconst nodemailer = require('nodemailer');\r\n\r\n// =================== CONFIGURACI√ìN DE CORREO ===================\r\nconst transporter = nodemailer.createTransport({\r\n  service: 'gmail',\r\n  auth: {\r\n    user: 'monica.romeroz.2003@gmail.com',\r\n    pass: 'txapatbhiebaxbbg'\r\n  }\r\n});\r\n\r\n// =================== PRODUCTOS ===================\r\n\r\n// Esquema actualizado del producto\r\nconst productSchema = new mongoose.Schema({\r\n  codigo: { type: Number, required: true },\r\n  name: { type: String, required: true },\r\n  description: { type: String, required: true },\r\n  image: { type: String, required: true },\r\n  image1: { type: String, required: false },\r\n  image2: { type: String, required: false },\r\n  image3: { type: String, required: false },\r\n  stock: { type: Number, required: true },\r\n  category: { type: String, required: true },\r\n  estado: { \r\n    type: String, \r\n    enum: ['Normal', 'Oferta'], // <-- solo acepta estos dos valores\r\n    required: true \r\n  },\r\n  videoURL: { type: String, required: false },\r\n  featuresText: { type: String, required: false },\r\n  tagsText: { type: String, required: false },\r\n  destacado: { type: Boolean, default: false }\r\n});\r\n\r\nconst Product = mongoose.model('Product', productSchema);\r\n\r\n// =================== RUTAS ===================\r\n\r\n// Obtener todos los productos (con filtros opcionales)\r\napp.get('/products', async (req, res) => {\r\n  try {\r\n    const { category, estado } = req.query;\r\n\r\n    const query = {};\r\n    if (category) query.category = category;\r\n    if (estado) query.estado = estado; // <-- permite filtrar por Normal u Oferta\r\n\r\n    const products = await Product.find(query);\r\n    res.json(products);\r\n  } catch (err) {\r\n    res.status(500).json({ message: 'Error fetching products', error: err });\r\n  }\r\n});\r\n\r\n// Obtener producto por ID\r\napp.get('/products/:id', async (req, res) => {\r\n  try {\r\n    const product = await Product.findById(req.params.id);\r\n    if (!product) return res.status(404).json({ message: 'Product not found' });\r\n    res.json(product);\r\n  } catch (err) {\r\n    res.status(500).json({ message: 'Error fetching product', error: err });\r\n  }\r\n});\r\n\r\n// Crear un nuevo producto\r\napp.post('/products', async (req, res) => {\r\n  try {\r\n    console.log('üì• POST /products recibido');\r\n    console.log('Body:', req.body);\r\n\r\n    if (!req.body || Object.keys(req.body).length === 0) {\r\n      return res.status(400).json({\r\n        message: 'Error: Request body vac√≠o o indefinido',\r\n        receivedHeaders: req.headers\r\n      });\r\n    }\r\n\r\n    const {\r\n      codigo,\r\n      name,\r\n      description,\r\n      image,\r\n      image1,\r\n      image2,\r\n      image3,\r\n      stock,\r\n      category,\r\n      estado,\r\n      videoURL,\r\n      featuresText,\r\n      tagsText,\r\n      destacado\r\n    } = req.body;\r\n\r\n    // Validaciones m√≠nimas\r\n    if (!codigo || !name || !description || !image || !stock || !category || !estado) {\r\n      return res.status(400).json({\r\n        message: 'Faltan campos obligatorios',\r\n        receivedData: req.body\r\n      });\r\n    }\r\n\r\n    const newProduct = new Product({\r\n      codigo,\r\n      name,\r\n      description,\r\n      image,\r\n      image1,\r\n      image2,\r\n      image3,\r\n      stock,\r\n      category,\r\n      estado,\r\n      videoURL,\r\n      featuresText,\r\n      tagsText,\r\n      destacado\r\n    });\r\n\r\n    await newProduct.save();\r\n    console.log('‚úÖ Producto guardado correctamente:', newProduct);\r\n    res.status(201).json(newProduct);\r\n  } catch (err) {\r\n    console.error('‚ùå Error al crear producto:', err);\r\n    res.status(400).json({\r\n      message: 'Error creando producto',\r\n      error: err.message || err,\r\n      stack: err.stack\r\n    });\r\n  }\r\n});\r\n\r\n// Actualizar un producto por ID\r\napp.put('/products/:id', async (req, res) => {\r\n  try {\r\n    const updatedProduct = await Product.findByIdAndUpdate(req.params.id, req.body, { new: true });\r\n    if (!updatedProduct) return res.status(404).json({ message: 'Product not found' });\r\n    res.json(updatedProduct);\r\n  } catch (err) {\r\n    res.status(400).json({ message: 'Error updating product', error: err });\r\n  }\r\n});\r\n\r\n// Eliminar un producto por ID\r\napp.delete('/products/:id', async (req, res) => {\r\n  try {\r\n    const deletedProduct = await Product.findByIdAndDelete(req.params.id);\r\n    if (!deletedProduct) return res.status(404).json({ message: 'Product not found' });\r\n    res.json({ message: 'Product deleted successfully' });\r\n  } catch (err) {\r\n    res.status(500).json({ message: 'Error deleting product', error: err });\r\n  }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// =================== orden===================\r\n\r\n\r\nconst ordenSchema = new mongoose.Schema({\r\n  nombre: String,\r\n  email: String,\r\n  productos: [\r\n    {\r\n      name: String,\r\n      cantidad: Number,\r\n      price: Number\r\n    }\r\n  ],\r\n  total: Number,\r\n  fecha: {\r\n    type: Date,\r\n    default: Date.now\r\n  }\r\n});\r\n\r\nconst Orden = mongoose.model('Orden', ordenSchema);\r\n\r\n\r\napp.post('/ordenes', async (req, res) => {\r\n  try {\r\n    const { nombre, email, productos, total } = req.body;\r\n\r\n    // Guardar la orden en MongoDB\r\n    const nuevaOrden = new Orden({ nombre, email, productos, total });\r\n    await nuevaOrden.save();\r\n\r\n    // Armar el mensaje del correo\r\n    const resumen = productos\r\n      .map(p => `- ${p.name} (x${p.cantidad}) - S/ ${p.price * p.cantidad}`)\r\n      .join('\\n');\r\n\r\n    const mensaje = `Hola ${nombre},\\n\\nGracias por tu compra en DINSAC.\\n\\nResumen:\\n${resumen}\\n\\nTotal: S/ ${total}\\n\\nSaludos,\\nEquipo DINSAC`;\r\n\r\n    // Enviar correo\r\n    await transporter.sendMail({\r\n      from: 'tucorreo@gmail.com', // reemplaza por tu correo real\r\n      to: email,\r\n      subject: 'üßæ Confirmaci√≥n de tu compra en DINSAC, ¬°Gracias por tu compra en DINSAC! üéâ',\r\n      text: mensaje\r\n    });\r\n\r\n    res.status(200).json({ message: 'Orden registrada y correo enviado.' });\r\n  } catch (error) {\r\n    console.error('Error al registrar orden:', error);\r\n    res.status(500).json({ message: 'Error al guardar orden o enviar correo.' });\r\n  }\r\n});\r\n\r\napp.get('/ordenes', async (req, res) => {\r\n  try {\r\n    const ordenes = await Orden.find().sort({ fecha: -1 }); // m√°s recientes arriba\r\n    res.json(ordenes);\r\n  } catch (error) {\r\n    res.status(500).json({ message: 'Error al obtener √≥rdenes' });\r\n  }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n// =================== para IA  ===================\r\n// ========== ESQUEMA DE INTERACCIONES ==========\r\nconst interaccionSchema = new mongoose.Schema({\r\n  usuario: String,\r\n  mensaje: String,\r\n  fecha: Date\r\n});\r\n\r\nconst Interaccion = mongoose.model('Interaccion', interaccionSchema);\r\n\r\n// ========== RUTA PARA GUARDAR ==========\r\napp.post('/interacciones', async (req, res) => {\r\n  try {\r\n    const nueva = new Interaccion(req.body);\r\n    await nueva.save();\r\n    res.status(201).json({ message: '‚úÖ Interacci√≥n guardada' });\r\n  } catch (err) {\r\n    res.status(500).json({ error: 'Error al guardar la interacci√≥n' });\r\n  }\r\n});\r\n\r\n// ========== RUTA PARA OBTENER ==========\r\napp.get('/interacciones', async (req, res) => {\r\n  try {\r\n    const interacciones = await Interaccion.find().sort({ fecha: -1 });\r\n    res.json(interacciones);\r\n  } catch (err) {\r\n    res.status(500).json({ error: 'Error al obtener interacciones' });\r\n  }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n// =================== COTIZACION  ===================\r\n\r\nconst cotizacionSchema = new mongoose.Schema({\r\n  numeroCotizacion: { type: String, required: true, unique: true },\r\nuserId: { type: mongoose.Schema.Types.ObjectId, ref: 'UserCliente', required: true },\r\n  nombre: String,\r\n  dniRuc: String,\r\n  email: String,\r\n  telefonoMovil: String,\r\n  mensaje: String,\r\n  contacto: String,\r\n  productos: [\r\n    {\r\n      categoria: String,\r\n      equipo: String,\r\n      cantidad: Number,\r\n      precioUnitario: Number\r\n    }\r\n  ],\r\n  pdfBase64: String,\r\n  fecha: { type: Date, default: Date.now },\r\n  estado: { type: String, default: 'pendiente' }, // üü¢ <--- AGREGA ESTO\r\n  createdAt: { type: Date, default: Date.now },\r\n  updatedAt: { type: Date, default: Date.now }\r\n});\r\n\r\n\r\n\r\nconst Cotizacion = mongoose.model('Cotizacion', cotizacionSchema);\r\n\r\n\r\n\r\n// ===================  GUARDAR COTIZACION  ===================\r\n\r\n// ‚úÖ Endpoint corregido para guardar cotizaci√≥n y enviar correo\r\napp.post('/cotizaciones', async (req, res) => {\r\n  try {\r\n    console.log('üìß Procesando cotizaci√≥n...');\r\n\r\n    // üëâ Usar el n√∫mero que viene del frontend o generar uno nuevo\r\n    let numeroCotizacion = req.body.numeroCotizacion;\r\n    \r\n    if (!numeroCotizacion) {\r\n      const total = await Cotizacion.countDocuments();\r\n      const numero = total + 1;\r\n      numeroCotizacion = `COT-${numero.toString().padStart(8, '0')}`;\r\n    }\r\n\r\n    // üëâ Crear nueva cotizaci√≥n\r\nconst nuevaCotizacion = new Cotizacion({\r\n  numeroCotizacion,\r\n  userId: req.body.userId, // üëà vincula con el cliente logueado\r\n  nombre: req.body.nombre,\r\n  dniRuc: req.body.dniRuc,\r\n  email: req.body.email,\r\n  telefonoMovil: req.body.telefonoMovil,\r\n  mensaje: req.body.mensaje,\r\n  contacto: req.body.contacto,\r\n  productos: req.body.productos,\r\n  pdfBase64: req.body.pdfBase64,\r\n  fecha: new Date(),\r\n  estado: 'pendiente' // üîπ por defecto al crear\r\n});\r\n\r\n\r\n    await nuevaCotizacion.save();\r\n    console.log('‚úÖ Cotizaci√≥n guardada en BD');\r\n\r\n    // üëâ Convertir el PDF base64 a buffer\r\n    const pdfBuffer = Buffer.from(req.body.pdfBase64, 'base64');\r\n\r\n    // üëâ Configurar correo\r\n    const mailOptions = {\r\n      from: process.env.EMAIL_USER,\r\n      to: `${req.body.email}, ${process.env.EMAIL_OWNER || 'admin@tuempresa.com'}`,\r\n      subject: `Cotizaci√≥n ${numeroCotizacion} - Distribuidora Industrial S.A.C.`,\r\n      html: `\r\n        <h3>Cotizaci√≥n ${numeroCotizacion}</h3>\r\n        <p><strong>Cliente:</strong> ${req.body.nombre}</p>\r\n        <p><strong>Email:</strong> ${req.body.email}</p>\r\n        <p><strong>Tel√©fono:</strong> ${req.body.telefonoMovil}</p>\r\n        <p><strong>Mensaje:</strong> ${req.body.mensaje}</p>\r\n        <br>\r\n        <p>Adjuntamos la cotizaci√≥n en formato PDF.</p>\r\n        <p><em>Distribuidora Industrial S.A.C.</em></p>\r\n      `,\r\n      attachments: [\r\n        {\r\n          filename: `Cotizacion_${numeroCotizacion}.pdf`,\r\n          content: pdfBuffer,\r\n          contentType: 'application/pdf'\r\n        }\r\n      ]\r\n    };\r\n\r\n    // üëâ Enviar correo\r\n    await transporter.sendMail(mailOptions);\r\n    console.log('‚úÖ Correo enviado exitosamente');\r\n\r\n    res.status(201).json({ \r\n      message: `Cotizaci√≥n ${numeroCotizacion} guardada y enviada por correo exitosamente`,\r\n      numeroCotizacion,\r\n      success: true\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error:', error);\r\n    res.status(500).json({\r\n      message: 'Error al procesar la cotizaci√≥n',\r\n      error: error.message,\r\n      success: false\r\n    });\r\n  }\r\n});\r\n\r\n\r\n// üîπ Contar cotizaciones pendientes\r\n// üîπ Contar cotizaciones pendientes (usando Mongoose)\r\napp.get('/cotizaciones/pendientes/total', async (req, res) => {\r\n  try {\r\n    const totalPendientes = await Cotizacion.countDocuments({ estado: 'pendiente' });\r\n    res.json({ total: totalPendientes });\r\n  } catch (error) {\r\n    console.error('‚ùå Error al contar cotizaciones pendientes:', error);\r\n    res.status(500).json({\r\n      message: 'Error al obtener cotizaciones pendientes',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\napp.delete('/cotizaciones/:id', async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    await Cotizacion.findByIdAndDelete(id);\r\n    res.json({ message: 'Cotizaci√≥n eliminada correctamente' });\r\n  } catch (error) {\r\n    console.error('Error al eliminar cotizaci√≥n:', error);\r\n    res.status(500).json({ message: 'Error al eliminar cotizaci√≥n' });\r\n  }\r\n});\r\n\r\n// ===================  contar COTIZACION  ===================\r\n\r\n\r\napp.get('/cotizaciones/total', async (req, res) => {\r\n  try {\r\n    const total = await Cotizacion.countDocuments();\r\n    res.json({ total });\r\n  } catch (err) {\r\n    res.status(500).json({ message: 'Error al contar cotizaciones', error: err });\r\n  }\r\n});\r\n\r\n\r\n\r\n\r\n// =================== HISTORIAL DE COTIZACIONES ===================\r\n// =================== HISTORIAL DE COTIZACIONES ===================\r\n\r\n/**\r\n * GET /cotizaciones\r\n * Obtiene todas las cotizaciones (para panel admin)\r\n */\r\napp.get('/cotizaciones', async (req, res) => {\r\n  try {\r\n    const historial = await Cotizacion.find()\r\n      .sort({ fecha: -1 })\r\n      .populate('userId', 'nombre email')\r\n      .lean();\r\n\r\n    // Normaliza nombres de productos\r\n    historial.forEach(cot => {\r\n      if (cot.productos && Array.isArray(cot.productos)) {\r\n        cot.productos = cot.productos.map(p => ({\r\n          nombre: p.nombre || p.name || 'Sin nombre',\r\n          cantidad: p.cantidad || 1,\r\n          precio: p.precio || 0\r\n        }));\r\n      }\r\n    });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      count: historial.length,\r\n      data: historial,\r\n    });\r\n  } catch (err) {\r\n    console.error('Error al obtener todas las cotizaciones:', err);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error al obtener cotizaciones',\r\n      error: err.message,\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /cotizaciones/usuario/:userId\r\n * Obtiene las cotizaciones de un usuario espec√≠fico\r\n */\r\napp.get('/cotizaciones/usuario/:userId', async (req, res) => {\r\n  try {\r\n    const { userId } = req.params;\r\n\r\n    if (!userId || userId === 'undefined' || userId === 'null') {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'ID de usuario no v√°lido',\r\n      });\r\n    }\r\n\r\n    console.log(`üîé Buscando historial de cotizaciones del usuario: ${userId}`);\r\n\r\n    // Buscar cotizaciones del usuario con populate\r\n    const cotizaciones = await Cotizacion.find({ userId })\r\n      .sort({ fecha: -1 })\r\n      .populate({\r\n        path: 'productos.productoId',\r\n        model: 'Product', // Aseg√∫rate de que coincida con el nombre de tu modelo\r\n        select: 'name nombre image category description precio',\r\n        strictPopulate: false\r\n      })\r\n      .select('fecha productos estado createdAt updatedAt')\r\n      .lean();\r\n\r\n    // Ajustamos el formato de los productos\r\n    cotizaciones.forEach(cot => {\r\n      if (cot.productos && Array.isArray(cot.productos)) {\r\n        cot.productos = cot.productos.map(p => {\r\n          const producto = p.productoId || {};\r\n          return {\r\n          nombre: p.equipo || p.nombre || p.name || 'Sin nombre',\r\n            cantidad: p.cantidad || 1,\r\n            precio: producto.precio || 0,\r\n            imagen: producto.image || '',\r\n            categoria: producto.category || '',\r\n          };\r\n        });\r\n      }\r\n    });\r\n\r\n    return res.status(200).json({\r\n      success: true,\r\n      count: cotizaciones.length,\r\n      data: cotizaciones,\r\n    });\r\n  } catch (err) {\r\n    console.error('Error al obtener historial del usuario:', err);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error al obtener historial del usuario',\r\n      error: err.message,\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /cotizaciones/:cotizacionId\r\n * Obtiene los detalles de una cotizaci√≥n espec√≠fica\r\n */\r\napp.get('/cotizaciones/:cotizacionId', async (req, res) => {\r\n  try {\r\n    const { cotizacionId } = req.params;\r\n\r\n    if (!cotizacionId || cotizacionId === 'undefined') {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'ID de cotizaci√≥n no v√°lido',\r\n      });\r\n    }\r\n\r\n    const cotizacion = await Cotizacion.findById(cotizacionId)\r\n      .populate({\r\n        path: 'productos.productoId',\r\n        model: 'Product',\r\n        select: 'name nombre image category description precio',\r\n        strictPopulate: false\r\n      })\r\n      .lean();\r\n\r\n    if (!cotizacion) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Cotizaci√≥n no encontrada',\r\n      });\r\n    }\r\n\r\n    // Normaliza productos\r\n    if (cotizacion.productos && Array.isArray(cotizacion.productos)) {\r\n      cotizacion.productos = cotizacion.productos.map(p => {\r\n        const producto = p.productoId || {};\r\n        return {\r\n        nombre: p.equipo || p.nombre || p.name || 'Sin nombre',\r\n          cantidad: p.cantidad || 1,\r\n          precio: producto.precio || 0,\r\n          imagen: producto.image || '',\r\n          categoria: producto.category || '',\r\n        };\r\n      });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: cotizacion,\r\n    });\r\n  } catch (err) {\r\n    console.error('Error al obtener cotizaci√≥n:', err);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error al obtener la cotizaci√≥n',\r\n      error: err.message,\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * PATCH /cotizaciones/:cotizacionId/estado\r\n * Actualiza el estado de una cotizaci√≥n\r\n */\r\napp.patch('/cotizaciones/:cotizacionId/estado', async (req, res) => {\r\n  try {\r\n    const { cotizacionId } = req.params;\r\n    const { estado } = req.body;\r\n\r\n    const estadosPermitidos = [\r\n      'pendiente',\r\n      'en proceso',\r\n      'atendida',\r\n      'completada',\r\n      'cancelada',\r\n    ];\r\n\r\n    if (!estado || !estadosPermitidos.includes(estado.toLowerCase())) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Estado no v√°lido',\r\n        estadosPermitidos,\r\n      });\r\n    }\r\n\r\n    const cotizacion = await Cotizacion.findByIdAndUpdate(\r\n      cotizacionId,\r\n      { estado: estado.toLowerCase(), updatedAt: new Date() },\r\n      { new: true, runValidators: true }\r\n    );\r\n\r\n    if (!cotizacion) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Cotizaci√≥n no encontrada',\r\n      });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: 'Estado actualizado correctamente',\r\n      data: cotizacion,\r\n    });\r\n  } catch (err) {\r\n    console.error('Error al actualizar estado:', err);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error al actualizar el estado',\r\n      error: err.message,\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * DELETE /cotizaciones/:cotizacionId\r\n * Elimina una cotizaci√≥n\r\n */\r\napp.delete('/cotizaciones/:cotizacionId', async (req, res) => {\r\n  try {\r\n    const { cotizacionId } = req.params;\r\n\r\n    const cotizacion = await Cotizacion.findByIdAndDelete(cotizacionId);\r\n\r\n    if (!cotizacion) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Cotizaci√≥n no encontrada',\r\n      });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: 'Cotizaci√≥n eliminada correctamente',\r\n    });\r\n  } catch (err) {\r\n    console.error('Error al eliminar cotizaci√≥n:', err);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Error al eliminar la cotizaci√≥n',\r\n      error: err.message,\r\n    });\r\n  }\r\n});\r\n\r\napp.put('/cotizaciones/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { estado } = req.body;\r\n\r\n    const cotizacion = await Cotizacion.findByIdAndUpdate(\r\n      id,\r\n      { estado },\r\n      { new: true }\r\n    );\r\n\r\n    if (!cotizacion) {\r\n      return res.status(404).json({ success: false, message: 'Cotizaci√≥n no encontrada' });\r\n    }\r\n\r\n    res.json({ success: true, data: cotizacion });\r\n  } catch (error) {\r\n    console.error(error);\r\n    res.status(500).json({ success: false, message: 'Error al actualizar el estado' });\r\n  }\r\n});\r\n\r\n\r\n\r\n\r\n// =================== FIN PRODUCTOS ===================\r\n\r\n// Iniciar servidor\r\napp.listen(PORT, () => {\r\n    console.log(`Server running on http://localhost:${PORT}`);\r\n});\r\n\r\n\r\n\r\n\r\n\r\n"]}