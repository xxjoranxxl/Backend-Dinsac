"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}var express=require("express"),mongoose=require("mongoose"),cors=require("cors"),app=express(),PORT=3e3,PDFDocument=require("pdfkit");app.use(cors({origin:["http://localhost:4200","http://localhost:3200"],methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"]})),app.use(express.json({limit:"60mb"})),app.use(express.urlencoded({extended:!0,limit:"50mb"})),app.use(express.json({limit:"80mb"})),app.use(function(e,r,t){if("text/plain"===e.headers["content-type"]&&e.body&&"string"==typeof e.body)try{e.body=JSON.parse(e.body),console.log("Converted text/plain to JSON:",e.body)}catch(e){console.error("Failed to parse text/plain as JSON:",e)}t()});var dbURI="mongodb://localhost:27017/mydatabase";mongoose.connect(dbURI).then(function(){return console.log("MongoDB connected")}).catch(function(e){return console.error("MongoDB connection error:",e)});var userSchema=new mongoose.Schema({username:{type:String,required:!0,unique:!0},password:{type:String,required:!0},role:{type:String,default:"admin"}}),User=mongoose.model("User",userSchema);function createAdminUser(){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(User.findOne({username:"admin"}));case 2:if(e.sent){e.next=10;break}return r=new User({username:"admin",password:"admin123",role:"admin"}),e.next=7,regeneratorRuntime.awrap(r.save());case 7:console.log("Admin user created"),e.next=11;break;case 10:console.log("Admin user already exists");case 11:case"end":return e.stop()}})}createAdminUser(),app.post("/favorites",function(r,t){var n,a,o,s,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.body,a=n.userId,o=n.productId,a&&o){e.next=4;break}return e.abrupt("return",t.status(400).json({message:"Faltan userId o productId"}));case 4:return e.next=6,regeneratorRuntime.awrap(UserCliente.findById(a));case 6:if(s=e.sent){e.next=9;break}return e.abrupt("return",t.status(404).json({message:"Usuario no encontrado"}));case 9:if(s.favorites.includes(o)){e.next=14;break}return s.favorites.push(o),s.favorites=_toConsumableArray(new Set(s.favorites.map(function(e){return e.toString()}))),e.next=14,regeneratorRuntime.awrap(s.save());case 14:return e.next=16,regeneratorRuntime.awrap(UserCliente.findById(a).populate("favorites"));case 16:c=e.sent,t.json({message:"Producto agregado a favoritos",favorites:c.favorites}),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(0),console.error("‚ùå Error en POST /favorites:",e.t0),t.status(500).json({message:"Error al agregar a favoritos",error:e.t0.message});case 24:case"end":return e.stop()}},null,null,[[0,20]])}),app.get("/favorites/:userId",function(r,t){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.params.userId,e.next=4,regeneratorRuntime.awrap(UserCliente.findById(n).populate("favorites"));case 4:if(a=e.sent){e.next=7;break}return e.abrupt("return",t.status(404).json({message:"Usuario no encontrado"}));case 7:t.json({message:"Favoritos obtenidos correctamente",favorites:a.favorites}),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("‚ùå Error en GET /favorites/:userId:",e.t0),t.status(500).json({message:"Error al obtener favoritos",error:e.t0.message});case 14:case"end":return e.stop()}},null,null,[[0,10]])}),app.delete("/favorites/:userId/:productId",function(r,t){var n,a,o,s,c,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.params,a=n.userId,o=n.productId,e.next=4,regeneratorRuntime.awrap(UserCliente.findById(a));case 4:if(s=e.sent){e.next=7;break}return e.abrupt("return",t.status(404).json({message:"Usuario no encontrado"}));case 7:if(c=s.favorites.length,s.favorites=s.favorites.filter(function(e){return e.toString()!==o}),c===s.favorites.length)return e.abrupt("return",t.status(404).json({message:"Producto no estaba en favoritos"}));e.next=11;break;case 11:return e.next=13,regeneratorRuntime.awrap(s.save());case 13:return e.next=15,regeneratorRuntime.awrap(UserCliente.findById(a).populate("favorites"));case 15:i=e.sent,t.json({message:"Producto eliminado de favoritos",favorites:i.favorites}),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(0),console.error("‚ùå Error en DELETE /favorites/:userId/:productId:",e.t0),t.status(500).json({message:"Error al eliminar de favoritos",error:e.t0.message});case 23:case"end":return e.stop()}},null,null,[[0,19]])}),app.get("/users",function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(User.find());case 3:t=e.sent,r.json(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({message:"Error al obtener usuarios",error:e.t0});case 10:case"end":return e.stop()}},null,null,[[0,7]])}),app.post("/login",function(r,t){var n,a,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body,a=n.username,o=n.password,e.next=3,regeneratorRuntime.awrap(User.findOne({username:a,password:o}));case 3:(s=e.sent)?t.json({message:"Login successful",user:s}):t.status(401).json({message:"Invalid credentials"});case 5:case"end":return e.stop()}})}),app.post("/register",function(r,t){var n,a,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body,a=n.username,o=n.password,e.prev=1,e.next=4,regeneratorRuntime.awrap(User.findOne({username:a}));case 4:if(e.sent)return e.abrupt("return",t.status(400).json({message:"El usuario ya existe"}));e.next=7;break;case 7:return s=new User({username:a,password:o,role:"cliente"}),e.next=10,regeneratorRuntime.awrap(s.save());case 10:t.status(201).json({message:"Cliente registrado correctamente",user:s}),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),t.status(500).json({message:"Error al registrar cliente",error:e.t0});case 16:case"end":return e.stop()}},null,null,[[1,13]])});var userClienteSchema=new mongoose.Schema({password:{type:String,required:!0},nombre:{type:String,required:!0},email:{type:String,required:!0,unique:!0},telefono:{type:String},direccion:{type:String},favorites:[{type:mongoose.Schema.Types.ObjectId,ref:"Product"}]}),UserCliente=mongoose.model("UserCliente",userClienteSchema);app.get("/clientes",function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(UserCliente.find().select("-password"));case 3:t=e.sent,r.json(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({message:"Error al obtener clientes",error:e.t0.message});case 10:case"end":return e.stop()}},null,null,[[0,7]])}),app.post("/clientes/register",function(r,t){var n,a,o,s,c,i,u,d,p,l,m;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Datos recibidos para registro:",r.body),n=r.body,a=n.password,o=n.nombre,s=n.email,c=n.telefono,i=n.direccion,a&&o&&s){e.next=5;break}return e.abrupt("return",t.status(400).json({message:"Password, nombre y email son obligatorios",receivedData:r.body}));case 5:return e.next=7,regeneratorRuntime.awrap(UserCliente.findOne({email:s}));case 7:if(e.sent)return e.abrupt("return",t.status(400).json({message:"El email ya est√° registrado"}));e.next=10;break;case 10:return u=require("nodemailer"),d=u.createTransport({service:"gmail",auth:{user:"monica.romeroz.2003@gmail.com",pass:"txapatbhiebaxbbg"}}),p=new UserCliente({password:a,nombre:o,email:s,telefono:c||"",direccion:i||""}),e.next=15,regeneratorRuntime.awrap(p.save());case 15:l={from:"monica.romeroz.2003@gmail.com",to:s,subject:"Registro en la Web de DINSAC",text:"¬°Hola ".concat(o,"! \n  ¬°Gracias por registrarte en la plataforma de DINSAC!\n\nAhora puedes explorar nuestros productos y realizar tus compras cuando gustes.  \nSi tienes dudas, escr√≠benos a soporte@dinsac.com\n\n¬°Que tengas un excelente d√≠a!\n\nAtentamente,  \nEl equipo de DINSAC..")},d.sendMail(l,function(e,r){e?console.error("Error al enviar correo:",e):console.log("Correo enviado: "+r.response)}),m={_id:p._id,nombre:p.nombre,email:p.email,telefono:p.telefono,direccion:p.direccion},t.status(201).json({message:"Cliente registrado correctamente",cliente:m}),e.next=25;break;case 21:e.prev=21,e.t0=e.catch(0),console.error("Error registrando cliente:",e.t0),11e3===e.t0.code?t.status(400).json({message:"El email ya est√° registrado"}):t.status(500).json({message:"Error al registrar cliente",error:e.t0.message});case 25:case"end":return e.stop()}},null,null,[[0,21]])}),app.post("/clientes/login",function(r,t){var n,a,o,s,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Intento de login:",r.body),n=r.body,a=n.email,o=n.password,a&&o){e.next=5;break}return e.abrupt("return",t.status(400).json({message:"Email y password son obligatorios"}));case 5:return e.next=7,regeneratorRuntime.awrap(UserCliente.findOne({email:a,password:o}));case 7:(s=e.sent)?(c={_id:s._id,nombre:s.nombre,email:s.email,telefono:s.telefono,direccion:s.direccion},t.json({message:"Login exitoso",cliente:c,success:!0})):t.status(401).json({message:"Credenciales inv√°lidas",success:!1}),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(0),console.error("Error en login:",e.t0),t.status(500).json({message:"Error en el servidor",error:e.t0.message});case 15:case"end":return e.stop()}},null,null,[[0,11]])}),app.delete("/clientes/:id",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(UserCliente.findByIdAndDelete(r.params.id));case 3:if(n=e.sent){e.next=6;break}return e.abrupt("return",t.status(404).json({message:"Cliente no encontrado"}));case 6:t.json({message:"Cliente eliminado correctamente",cliente:{_id:n._id,nombre:n.nombre,email:n.email}}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Error eliminando cliente:",e.t0),t.status(500).json({message:"Error eliminando cliente",error:e.t0.message});case 13:case"end":return e.stop()}},null,null,[[0,9]])});var nodemailer=require("nodemailer"),transporter=nodemailer.createTransport({service:"gmail",auth:{user:"monica.romeroz.2003@gmail.com",pass:"txapatbhiebaxbbg"}}),productSchema=new mongoose.Schema({codigo:{type:Number,required:!0},name:{type:String,required:!0},description:{type:String,required:!0},image:{type:String,required:!0},image1:{type:String,required:!1},image2:{type:String,required:!1},image3:{type:String,required:!1},stock:{type:Number,required:!0},category:{type:String,required:!0},estado:{type:String,enum:["Normal","Oferta"],required:!0},videoURL:{type:String,required:!1},featuresText:{type:String,required:!1},tagsText:{type:String,required:!1},destacado:{type:Boolean,default:!1}}),Product=mongoose.model("Product",productSchema);app.get("/products",function(r,t){var n,a,o,s,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.query,a=n.category,o=n.estado,s={},a&&(s.category=a),o&&(s.estado=o),e.next=7,regeneratorRuntime.awrap(Product.find(s));case 7:c=e.sent,t.json(c),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),t.status(500).json({message:"Error fetching products",error:e.t0});case 14:case"end":return e.stop()}},null,null,[[0,11]])}),app.get("/products/:id",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Product.findById(r.params.id));case 3:if(n=e.sent){e.next=6;break}return e.abrupt("return",t.status(404).json({message:"Product not found"}));case 6:t.json(n),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(500).json({message:"Error fetching product",error:e.t0});case 12:case"end":return e.stop()}},null,null,[[0,9]])}),app.post("/products",function(r,t){var n,a,o,s,c,i,u,d,p,l,m,g,f,b,v,y;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("üì• POST /products recibido"),console.log("Body:",r.body),r.body&&0!==Object.keys(r.body).length){e.next=5;break}return e.abrupt("return",t.status(400).json({message:"Error: Request body vac√≠o o indefinido",receivedHeaders:r.headers}));case 5:if(n=r.body,a=n.codigo,o=n.name,s=n.description,c=n.image,i=n.image1,u=n.image2,d=n.image3,p=n.stock,l=n.category,m=n.estado,g=n.videoURL,f=n.featuresText,b=n.tagsText,v=n.destacado,a&&o&&s&&c&&p&&l&&m){e.next=8;break}return e.abrupt("return",t.status(400).json({message:"Faltan campos obligatorios",receivedData:r.body}));case 8:return y=new Product({codigo:a,name:o,description:s,image:c,image1:i,image2:u,image3:d,stock:p,category:l,estado:m,videoURL:g,featuresText:f,tagsText:b,destacado:v}),e.next=11,regeneratorRuntime.awrap(y.save());case 11:console.log("‚úÖ Producto guardado correctamente:",y),t.status(201).json(y),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("‚ùå Error al crear producto:",e.t0),t.status(400).json({message:"Error creando producto",error:e.t0.message||e.t0,stack:e.t0.stack});case 19:case"end":return e.stop()}},null,null,[[0,15]])}),app.put("/products/:id",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Product.findByIdAndUpdate(r.params.id,r.body,{new:!0}));case 3:if(n=e.sent){e.next=6;break}return e.abrupt("return",t.status(404).json({message:"Product not found"}));case 6:t.json(n),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(400).json({message:"Error updating product",error:e.t0});case 12:case"end":return e.stop()}},null,null,[[0,9]])}),app.delete("/products/:id",function(r,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Product.findByIdAndDelete(r.params.id));case 3:if(e.sent){e.next=6;break}return e.abrupt("return",t.status(404).json({message:"Product not found"}));case 6:t.json({message:"Product deleted successfully"}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(500).json({message:"Error deleting product",error:e.t0});case 12:case"end":return e.stop()}},null,null,[[0,9]])});var ordenSchema=new mongoose.Schema({nombre:String,email:String,productos:[{name:String,cantidad:Number,price:Number}],total:Number,fecha:{type:Date,default:Date.now}}),Orden=mongoose.model("Orden",ordenSchema);app.post("/ordenes",function(r,t){var n,a,o,s,c,i,u,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body,a=n.nombre,o=n.email,s=n.productos,c=n.total,i=new Orden({nombre:a,email:o,productos:s,total:c}),e.next=5,regeneratorRuntime.awrap(i.save());case 5:return u=s.map(function(e){return"- ".concat(e.name," (x").concat(e.cantidad,") - S/ ").concat(e.price*e.cantidad)}).join("\n"),d="Hola ".concat(a,",\n\nGracias por tu compra en DINSAC.\n\nResumen:\n").concat(u,"\n\nTotal: S/ ").concat(c,"\n\nSaludos,\nEquipo DINSAC"),e.next=9,regeneratorRuntime.awrap(transporter.sendMail({from:"tucorreo@gmail.com",to:o,subject:"üßæ Confirmaci√≥n de tu compra en DINSAC, ¬°Gracias por tu compra en DINSAC! üéâ",text:d}));case 9:t.status(200).json({message:"Orden registrada y correo enviado."}),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("Error al registrar orden:",e.t0),t.status(500).json({message:"Error al guardar orden o enviar correo."});case 16:case"end":return e.stop()}},null,null,[[0,12]])}),app.get("/ordenes",function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Orden.find().sort({fecha:-1}));case 3:t=e.sent,r.json(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({message:"Error al obtener √≥rdenes"});case 10:case"end":return e.stop()}},null,null,[[0,7]])});var interaccionSchema=new mongoose.Schema({usuario:String,mensaje:String,fecha:Date}),Interaccion=mongoose.model("Interaccion",interaccionSchema);app.post("/interacciones",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=new Interaccion(r.body),e.next=4,regeneratorRuntime.awrap(n.save());case 4:t.status(201).json({message:"‚úÖ Interacci√≥n guardada"}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),t.status(500).json({error:"Error al guardar la interacci√≥n"});case 10:case"end":return e.stop()}},null,null,[[0,7]])}),app.get("/interacciones",function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Interaccion.find().sort({fecha:-1}));case 3:t=e.sent,r.json(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({error:"Error al obtener interacciones"});case 10:case"end":return e.stop()}},null,null,[[0,7]])});var cotizacionSchema=new mongoose.Schema({numeroCotizacion:{type:String,required:!0,unique:!0},userId:{type:mongoose.Schema.Types.ObjectId,ref:"UserCliente",required:!0},nombre:String,dniRuc:String,email:String,telefonoMovil:String,mensaje:String,contacto:String,productos:[{categoria:String,equipo:String,cantidad:Number,precioUnitario:Number}],pdfBase64:String,fecha:{type:Date,default:Date.now},estado:{type:String,default:"pendiente"},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),Cotizacion=mongoose.model("Cotizacion",cotizacionSchema);app.post("/cotizaciones",function(r,t){var n,a,o,s,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("üìß Procesando cotizaci√≥n..."),n=r.body.numeroCotizacion){e.next=9;break}return e.next=6,regeneratorRuntime.awrap(Cotizacion.countDocuments());case 6:a=e.sent,n="COT-".concat((a+1).toString().padStart(8,"0"));case 9:return o=new Cotizacion({numeroCotizacion:n,userId:r.body.userId,nombre:r.body.nombre,dniRuc:r.body.dniRuc,email:r.body.email,telefonoMovil:r.body.telefonoMovil,mensaje:r.body.mensaje,contacto:r.body.contacto,productos:r.body.productos,pdfBase64:r.body.pdfBase64,fecha:new Date,estado:"pendiente"}),e.next=12,regeneratorRuntime.awrap(o.save());case 12:return console.log("‚úÖ Cotizaci√≥n guardada en BD"),s=Buffer.from(r.body.pdfBase64,"base64"),c={from:process.env.EMAIL_USER,to:"".concat(r.body.email,", ").concat(process.env.EMAIL_OWNER||"admin@tuempresa.com"),subject:"Cotizaci√≥n ".concat(n," - Distribuidora Industrial S.A.C."),html:"\n        <h3>Cotizaci√≥n ".concat(n,"</h3>\n        <p><strong>Cliente:</strong> ").concat(r.body.nombre,"</p>\n        <p><strong>Email:</strong> ").concat(r.body.email,"</p>\n        <p><strong>Tel√©fono:</strong> ").concat(r.body.telefonoMovil,"</p>\n        <p><strong>Mensaje:</strong> ").concat(r.body.mensaje,"</p>\n        <br>\n        <p>Adjuntamos la cotizaci√≥n en formato PDF.</p>\n        <p><em>Distribuidora Industrial S.A.C.</em></p>\n      "),attachments:[{filename:"Cotizacion_".concat(n,".pdf"),content:s,contentType:"application/pdf"}]},e.next=17,regeneratorRuntime.awrap(transporter.sendMail(c));case 17:console.log("‚úÖ Correo enviado exitosamente"),t.status(201).json({message:"Cotizaci√≥n ".concat(n," guardada y enviada por correo exitosamente"),numeroCotizacion:n,success:!0}),e.next=25;break;case 21:e.prev=21,e.t0=e.catch(0),console.error("‚ùå Error:",e.t0),t.status(500).json({message:"Error al procesar la cotizaci√≥n",error:e.t0.message,success:!1});case 25:case"end":return e.stop()}},null,null,[[0,21]])}),app.get("/cotizaciones/pendientes/total",function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Cotizacion.countDocuments({estado:"pendiente"}));case 3:t=e.sent,r.json({total:t}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("‚ùå Error al contar cotizaciones pendientes:",e.t0),r.status(500).json({message:"Error al obtener cotizaciones pendientes",error:e.t0.message});case 11:case"end":return e.stop()}},null,null,[[0,7]])}),app.delete("/cotizaciones/:id",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.params.id,e.next=4,regeneratorRuntime.awrap(Cotizacion.findByIdAndDelete(n));case 4:t.json({message:"Cotizaci√≥n eliminada correctamente"}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("Error al eliminar cotizaci√≥n:",e.t0),t.status(500).json({message:"Error al eliminar cotizaci√≥n"});case 11:case"end":return e.stop()}},null,null,[[0,7]])}),app.get("/cotizaciones/total",function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Cotizacion.countDocuments());case 3:t=e.sent,r.json({total:t}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({message:"Error al contar cotizaciones",error:e.t0});case 10:case"end":return e.stop()}},null,null,[[0,7]])}),app.get("/cotizaciones",function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Cotizacion.find().sort({fecha:-1}).populate("userId","nombre email").lean());case 3:(t=e.sent).forEach(function(e){e.productos&&Array.isArray(e.productos)&&(e.productos=e.productos.map(function(e){return{nombre:e.nombre||e.name||"Sin nombre",cantidad:e.cantidad||1,precio:e.precio||0}}))}),r.status(200).json({success:!0,count:t.length,data:t}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("Error al obtener todas las cotizaciones:",e.t0),r.status(500).json({success:!1,message:"Error al obtener cotizaciones",error:e.t0.message});case 12:case"end":return e.stop()}},null,null,[[0,8]])}),app.get("/cotizaciones/usuario/:userId",function(r,t){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(n=r.params.userId)&&"undefined"!==n&&"null"!==n){e.next=4;break}return e.abrupt("return",t.status(400).json({success:!1,message:"ID de usuario no v√°lido"}));case 4:return console.log("üîé Buscando historial de cotizaciones del usuario: ".concat(n)),e.next=7,regeneratorRuntime.awrap(Cotizacion.find({userId:n}).sort({fecha:-1}).populate({path:"productos.productoId",model:"Product",select:"name nombre image category description precio",strictPopulate:!1}).select("fecha productos estado createdAt updatedAt").lean());case 7:return(a=e.sent).forEach(function(e){e.productos&&Array.isArray(e.productos)&&(e.productos=e.productos.map(function(e){var r=e.productoId||{};return{nombre:e.equipo||e.nombre||e.name||"Sin nombre",cantidad:e.cantidad||1,precio:r.precio||0,imagen:r.image||"",categoria:r.category||""}}))}),e.abrupt("return",t.status(200).json({success:!0,count:a.length,data:a}));case 12:e.prev=12,e.t0=e.catch(0),console.error("Error al obtener historial del usuario:",e.t0),t.status(500).json({success:!1,message:"Error al obtener historial del usuario",error:e.t0.message});case 16:case"end":return e.stop()}},null,null,[[0,12]])}),app.get("/cotizaciones/:cotizacionId",function(r,t){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(n=r.params.cotizacionId)&&"undefined"!==n){e.next=4;break}return e.abrupt("return",t.status(400).json({success:!1,message:"ID de cotizaci√≥n no v√°lido"}));case 4:return e.next=6,regeneratorRuntime.awrap(Cotizacion.findById(n).populate({path:"productos.productoId",model:"Product",select:"name nombre image category description precio",strictPopulate:!1}).lean());case 6:if(a=e.sent){e.next=9;break}return e.abrupt("return",t.status(404).json({success:!1,message:"Cotizaci√≥n no encontrada"}));case 9:a.productos&&Array.isArray(a.productos)&&(a.productos=a.productos.map(function(e){var r=e.productoId||{};return{nombre:e.equipo||e.nombre||e.name||"Sin nombre",cantidad:e.cantidad||1,precio:r.precio||0,imagen:r.image||"",categoria:r.category||""}})),t.status(200).json({success:!0,data:a}),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(0),console.error("Error al obtener cotizaci√≥n:",e.t0),t.status(500).json({success:!1,message:"Error al obtener la cotizaci√≥n",error:e.t0.message});case 17:case"end":return e.stop()}},null,null,[[0,13]])}),app.patch("/cotizaciones/:cotizacionId/estado",function(r,t){var n,a,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.params.cotizacionId,a=r.body.estado,o=["pendiente","en proceso","atendida","completada","cancelada"],a&&o.includes(a.toLowerCase())){e.next=6;break}return e.abrupt("return",t.status(400).json({success:!1,message:"Estado no v√°lido",estadosPermitidos:o}));case 6:return e.next=8,regeneratorRuntime.awrap(Cotizacion.findByIdAndUpdate(n,{estado:a.toLowerCase(),updatedAt:new Date},{new:!0,runValidators:!0}));case 8:if(s=e.sent){e.next=11;break}return e.abrupt("return",t.status(404).json({success:!1,message:"Cotizaci√≥n no encontrada"}));case 11:t.status(200).json({success:!0,message:"Estado actualizado correctamente",data:s}),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(0),console.error("Error al actualizar estado:",e.t0),t.status(500).json({success:!1,message:"Error al actualizar el estado",error:e.t0.message});case 18:case"end":return e.stop()}},null,null,[[0,14]])}),app.delete("/cotizaciones/:cotizacionId",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.params.cotizacionId,e.next=4,regeneratorRuntime.awrap(Cotizacion.findByIdAndDelete(n));case 4:if(e.sent){e.next=7;break}return e.abrupt("return",t.status(404).json({success:!1,message:"Cotizaci√≥n no encontrada"}));case 7:t.status(200).json({success:!0,message:"Cotizaci√≥n eliminada correctamente"}),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("Error al eliminar cotizaci√≥n:",e.t0),t.status(500).json({success:!1,message:"Error al eliminar la cotizaci√≥n",error:e.t0.message});case 14:case"end":return e.stop()}},null,null,[[0,10]])}),app.put("/cotizaciones/:id",function(r,t){var n,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.params.id,a=r.body.estado,e.next=5,regeneratorRuntime.awrap(Cotizacion.findByIdAndUpdate(n,{estado:a},{new:!0}));case 5:if(o=e.sent){e.next=8;break}return e.abrupt("return",t.status(404).json({success:!1,message:"Cotizaci√≥n no encontrada"}));case 8:t.json({success:!0,data:o}),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(0),console.error(e.t0),t.status(500).json({success:!1,message:"Error al actualizar el estado"});case 15:case"end":return e.stop()}},null,null,[[0,11]])}),app.listen(PORT,function(){console.log("Server running on http://localhost:".concat(PORT))});
//# sourceMappingURL=server.min.js.map
